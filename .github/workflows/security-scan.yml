name: Security Scan
on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk security scan
        run: npm run security:scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk results
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk/
          retention-days: 30

      - name: Check for critical vulnerabilities
        run: |
          if [ -f snyk/test-results.json ]; then
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk/test-results.json 2>/dev/null || echo "0")
            if [ "$CRITICAL" -gt 0 ]; then
              echo "❌ Found $CRITICAL critical vulnerabilities"
              exit 1
            fi
            echo "✅ No critical vulnerabilities found"
          fi

  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Audit dependencies
        run: |
          npm audit --audit-level=high --json > audit-results.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: audit-results.json
          retention-days: 30

      - name: Check for high/critical vulnerabilities
        run: |
          if [ -s audit-results.json ]; then
            VULNS=$(jq '.[].vulnerabilities | length' audit-results.json 2>/dev/null || echo "0")
            if [ "$VULNS" -gt 0 ]; then
              echo "⚠️ Found vulnerabilities in dependencies:"
              jq -r '.[].vulnerabilities | keys | .[]' audit-results.json | head -20
              echo "..."
            else
              echo "✅ No high/critical vulnerabilities found"
            fi
          else
            echo "✅ No audit issues found"
          fi

  code-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint security checks
        run: npm run lint:security || echo "⚠️ Security linting completed with warnings"

      - name: Run SonarQube security analysis
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: "-Dsonar.security.reports.newCodes=true"

  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical
          deny-licenses: GPL-1.0, GPL-2.0, GPL-3.0, AGPL-1.0, AGPL-3.0, SSPL-1.0, OSL-1.0, OSL-2.0, OSL-3.0, CPL-1.0, EPL-1.0, EPL-2.0, MPL-1.1, MPL-2.0, AFL-1.1, AFL-2.0, AFL-3.0, GFDL-1.1, GFDL-1.2, GFDL-1.3, GFDL-2.0, GFDL-2.1, GFDL-2.2, GFDL-3.0

  secrets-detection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install gitleaks
        run: |
          curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sh -s v8.18.2

      - name: Run gitleaks
        run: |
          ./gitleaks detect --source=. --verbose --redact 2>&1 || echo "⚠️ Gitleaks scan completed"

      - name: Upload secrets scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-scan-results
          path: gitleaks-results.json
          retention-days: 7

  security-report:
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-audit, code-security, dependency-review]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the artifacts for detailed reports:" >> $GITHUB_STEP_SUMMARY
          echo "- Snyk results" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency audit" >> $GITHUB_STEP_SUMMARY
          echo "- Code security analysis" >> $GITHUB_STEP_SUMMARY
